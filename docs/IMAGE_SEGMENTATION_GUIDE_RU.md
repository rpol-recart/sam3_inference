# Руководство по сегментации изображений в SAM3 Inference Server

## Оглавление
1. [Введение](#введение)
2. [Типы промптов](#типы-промптов)
3. [Форматы данных](#форматы-данных)
4. [Оптимизация производительности](#оптимизация-производительности)
5. [Примеры использования](#примеры-использования)

## Введение

Сегментация изображений в SAM3 Inference Server позволяет выделять объекты на изображении с использованием различных типов промптов. Модель способна обрабатывать текстовые описания, точечные пометки и ограничивающие прямоугольники для точной сегментации.

### Основные возможности:
- Поддержка текстовых, точечных и прямоугольных промптов
- Комбинирование разных типов промптов
- Кэширование признаков для ускорения многократной обработки одного изображения
- Фильтрация результатов по порогу уверенности
- Поддержка батчевой обработки

## Типы промптов

### Текстовые промпты

Текстовые промпты позволяют указать объект для сегментации с помощью описания на естественном языке.

**Формат:**
```json
{
  "type": "text",
  "text": "описание объекта"
}
```

**Примеры:**
- `"человек"`
- `"автомобиль на дороге"`
- `"собака с ошейником"`

**Особенности:**
- Используется для грубой сегментации объектов
- Может быть неточным для сложных сцен
- Поддерживает описания с контекстом

### Прямоугольные промпты

Прямоугольные промпты задают ограничивающий прямоугольник вокруг объекта.

**Формат:**
```json
{
  "type": "box",
  "box": [cx, cy, w, h],
  "label": true
}
```

Где:
- `cx, cy` - координаты центра прямоугольника (нормализованные [0,1])
- `w, h` - ширина и высота прямоугольника (нормализованные [0,1])
- `label` - метка: true для положительного примера, false для отрицательного

**Пример:**
```json
{
  "type": "box",
  "box": [0.3, 0.4, 0.2, 0.3],
  "label": true
}
```

**Особенности:**
- Более точный, чем текстовый промпт
- Хорош для четко ограниченных объектов
- Может использоваться как положительный или отрицательный пример

### Точечные промпты

Точечные промпты позволяют указать конкретные точки на изображении с метками принадлежности.

**Формат:**
```json
{
  "type": "point",
  "points": [[x1, y1], [x2, y2], ...],
  "point_labels": [1, 0, ...]
}
```

Где:
- `points` - массив координат точек (нормализованные [0,1])
- `point_labels` - метки для каждой точки: 1 для переднего плана, 0 для фона

**Пример:**
```json
{
  "type": "point",
  "points": [[0.3, 0.4], [0.7, 0.6]],
  "point_labels": [1, 0]
}
```

**Особенности:**
- Наиболее точный тип промпта
- Позволяет точно указать, что нужно сегментировать
- Может использовать положительные и отрицательные примеры

## Форматы данных

### Входные данные

Все изображения передаются в формате base64:

```json
{
  "image": "iVBORw0KGgoAAAANSUhEUgAAAAUA...",
  "prompts": [...],
  "confidence_threshold": 0.5
}
```

### Выходные данные

Сервер возвращает результаты в следующем формате:

```json
{
  "masks": ["rle-закодированные маски"],
  "boxes": [[cx, cy, w, h]],
  "scores": [0.95],
  "num_masks": 1,
  "image_size": {"width": 640, "height": 480},
  "inference_time_ms": 123.4
}
```

#### Маски (masks)

Маски представлены в формате RLE (Run-Length Encoding) - эффективный способ представления бинарных масок.

#### Ограничивающие прямоугольники (boxes)

Прямоугольники в формате [cx, cy, w, h] (центр X, центр Y, ширина, высота), нормализованные к [0,1].

#### Оценки уверенности (scores)

Вероятности того, что объект соответствует промпту, в диапазоне [0,1].

## Оптимизация производительности

### Кэширование признаков

Для ускорения обработки одного изображения с несколькими текстовыми промптами используйте эндпоинт `/cached-features`:

```json
{
  "image": "base64-изображение",
  "text_prompts": ["человек", "автомобиль", "здание"],
  "confidence_threshold": 0.5
}
```

Этот подход ускоряет обработку в ~10 раз по сравнению с отдельными запросами.

### Порог уверенности

Настройте `confidence_threshold` для фильтрации результатов:
- 0.9 - очень уверенные результаты, меньше масок
- 0.5 - баланс между точностью и полнотой
- 0.1 - больше результатов, возможны ложные срабатывания

### Размеры изображений

Модель оптимизирована для изображений с разрешением до 1008 пикселей по большей стороне. Для больших изображений:

1. Измените размер заранее до оптимального
2. Или используйте настройку `image_model_resolution` в конфигурации

## Примеры использования

### Простая сегментация с текстовым промптом

```bash
curl -X POST "http://localhost:8000/api/v1/image/segment" \
  -H "Content-Type: application/json" \
  -d '{
    "image": "base64-изображение",
    "prompts": [
      {
        "type": "text",
        "text": "человек"
      }
    ],
    "confidence_threshold": 0.7
  }'
```

### Комбинированный промпт (текст + прямоугольник)

```json
{
  "image": "base64-изображение",
  "prompts": [
    {
      "type": "text",
      "text": "собака"
    },
    {
      "type": "box",
      "box": [0.4, 0.5, 0.3, 0.4],
      "label": true
    }
  ],
  "confidence_threshold": 0.6
}
```

### Множественные точечные промпты

```json
{
  "image": "base64-изображение",
  "prompts": [
    {
      "type": "point",
      "points": [[0.2, 0.3], [0.8, 0.7]],
      "point_labels": [1, 1]
    },
    {
      "type": "point",
      "points": [[0.5, 0.5]],
      "point_labels": [0]
    }
  ],
  "confidence_threshold": 0.5
}
```

### Кэширование признаков для нескольких текстовых промптов

```bash
curl -X POST "http://localhost:8000/api/v1/image/cached-features" \
  -H "Content-Type: application/json" \
  -d '{
    "image": "base64-изображение",
    "text_prompts": [
      "человек",
      "автомобиль",
      "дерево",
      "здание"
    ],
    "confidence_threshold": 0.6
  }'
```

## Советы по использованию

### Для высокой точности:
- Используйте точечные промпты с точными кликами
- Комбинируйте несколько типов промптов
- Устанавливайте высокий порог уверенности

### Для быстрой обработки:
- Используйте текстовые промпты для грубой сегментации
- Применяйте кэширование признаков для повторной обработки
- Уменьшайте разрешение входных изображений

### Для сложных сцен:
- Используйте комбинацию промптов
- Применяйте отрицательные примеры (точки или прямоугольники с меткой false)
- Настройте порог уверенности экспериментально

## Ограничения

- Максимальный размер загружаемого изображения ограничен настройкой `max_upload_size_mb`
- Поддерживаемые форматы: JPEG, PNG, и другие распространенные форматы
- Производительность зависит от размера изображения и количества промптов
- Для получения оптимальных результатов требуется GPU с достаточным объемом памяти