# SAM3 Inference Server - Полная документация

## Оглавление
1. [Общее описание](#общее-описание)
2. [Архитектура](#архитектура)
3. [Конфигурация](#конфигурация)
4. [Функциональность](#функциональность)
5. [API Руководство](#api-руководство)
6. [Развертывание](#развертывание)
7. [Устранение неполадок](#устранение-неполадок)

## Общее описание

SAM3 Inference Server - это высокопроизводительный сервер для инференса модели SAM3 (Segment Anything 3), реализованный на основе FastAPI. Сервер предоставляет API для сегментации изображений и видео с использованием различных типов промптов: текстовых, точечных и ограничивающих прямоугольников.

### Основные возможности:
- Сегментация изображений с поддержкой различных типов промптов
- Сегментация видео с отслеживанием объектов
- Поддержка кэширования признаков для ускорения обработки
- Многопользовательский режим с управлением сессиями
- Поддержка нескольких GPU
- WebSocket-стриминг для видеообработки в реальном времени

## Архитектура

Сервер построен по принципам Clean Architecture с разделением на следующие слои:

### Слои приложения:
1. **API слой** - маршруты FastAPI, обработка HTTP-запросов
2. **Сервисный слой** - бизнес-логика
3. **Модельный слой** - обертки для SAM3 моделей
4. **Слой схем** - Pydantic модели для валидации данных

### Компоненты:
- `app/main.py` - точка входа, инициализация приложения
- `app/core/config.py` - конфигурация приложения
- `app/api/v1/routes/` - маршруты API
- `app/services/` - сервисы бизнес-логики
- `app/models/` - обертки для SAM3 моделей
- `app/schemas/` - схемы данных
- `services/session_manager.py` - управление сессиями

## Конфигурация

Сервер настраивается через переменные окружения или файл `.env`. Основные параметры конфигурации:

### Серверные настройки:
- `SERVER_HOST` - хост для привязки сервера (по умолчанию: "0.0.0.0")
- `SERVER_PORT` - порт для привязки сервера (по умолчанию: 8000)
- `SERVER_WORKERS` - количество рабочих процессов (по умолчанию: 1)
- `LOG_LEVEL` - уровень логирования (по умолчанию: "INFO")
- `RELOAD` - включить автоперезагрузку (по умолчанию: False)

### Настройки моделей:
- `SAM3_CHECKPOINT` - путь к чекпоинту SAM3 (по умолчанию: "/app/server/sam_weights/sam3.pt")
- `SAM3_BPE_PATH` - путь к файлу токенизатора BPE (по умолчанию: "/app/server/sam_weights/bpe_simple_vocab_16e6.txt.gz")

### Настройки модели изображений:
- `IMAGE_MODEL_DEVICE` - устройство для модели изображений (по умолчанию: "cuda:0")
- `IMAGE_MODEL_COMPILE` - включить оптимизацию torch.compile (по умолчанию: False)
- `IMAGE_MODEL_CONFIDENCE_THRESHOLD` - порог уверенности (по умолчанию: 0.5)
- `IMAGE_MODEL_RESOLUTION` - разрешение входного изображения (по умолчанию: 1008)
- `IMAGE_MODEL_ENABLED` - включить модель изображений (по умолчанию: True)

### Настройки модели видео:
- `VIDEO_MODEL_ENABLED` - включить модель видео (по умолчанию: True)
- `VIDEO_MODEL_REQUIRED` - обязательна ли модель видео для запуска (по умолчанию: False)
- `VIDEO_GPU_LIST` - список ID GPU для обработки видео (по умолчанию: [0, 1, 2, 3])
- `VIDEO_MODEL_COMPILE` - включить torch.compile для видео (по умолчанию: False)

### Управление сессиями:
- `MAX_CONCURRENT_SESSIONS` - максимальное количество сессий (по умолчанию: 10)
- `SESSION_TIMEOUT_SECONDS` - таймаут сессии в секундах (по умолчанию: 3600)

### Кэширование:
- `ENABLE_FEATURE_CACHE` - включить кэширование признаков (по умолчанию: True)
- `FEATURE_CACHE_TTL_SECONDS` - время жизни кэша в секундах (по умолчанию: 600)
- `MAX_CACHE_SIZE_MB` - максимальный размер кэша в МБ (по умолчанию: 4096)

### Безопасность:
- `REQUIRE_API_KEY` - требовать API-ключ для запросов (по умолчанию: False)
- `API_KEYS` - список валидных API-ключей
- `CORS_ORIGINS_LIST` - список разрешенных CORS-источников

### Ограничение частоты:
- `RATE_LIMIT_ENABLED` - включить ограничение частоты (по умолчанию: True)
- `RATE_LIMIT_REQUESTS_PER_MINUTE` - максимальное количество запросов в минуту (по умолчанию: 100)

### Хранилище:
- `UPLOAD_DIR` - директория для загруженных файлов (по умолчанию: "/tmp/sam3_uploads")
- `OUTPUT_DIR` - директория для выходных файлов (по умолчанию: "/tmp/sam3_outputs")
- `MAX_UPLOAD_SIZE_MB` - максимальный размер загрузки в МБ (по умолчанию: 100)

## Функциональность

### Сегментация изображений

Сервер поддерживает несколько типов промптов для сегментации изображений:

1. **Текстовые промпты** - описание объекта для сегментации
2. **Прямоугольные промпты** - ограничивающие прямоугольники
3. **Точечные промпты** - клики (положительные и отрицательные)

Также доступна функция кэширования признаков, которая позволяет ускорить обработку одного изображения с несколькими текстовыми промптами в ~10 раз.

### Сегментация видео

Сервер предоставляет мощную систему сегментации видео с отслеживанием объектов:

1. **Сессии** - управление состоянием видеообработки
2. **Отслеживание объектов** - поддержка нескольких объектов в кадре
3. **Пропагация** - распространение сегментации по кадрам
4. **WebSocket-стриминг** - обработка в реальном времени

## API Руководство

### Корневой эндпоинт
```
GET /
```
Возвращает информацию о сервере и ссылки на документацию.

### Эндпоинты здоровья
```
GET /health
```
Проверяет статус работоспособности сервера.

### Эндпоинты сегментации изображений

#### Сегментация изображения
```
POST /api/v1/image/segment
```
Сегментирует изображение с использованием различных типов промптов.

**Тело запроса:**
```json
{
  "image": "base64-закодированное изображение",
  "prompts": [
    {
      "type": "text",
      "text": "описание объекта"
    }
  ],
  "confidence_threshold": 0.5,
  "return_visualization": false
}
```

**Типы промптов:**
- **Текстовый промпт:**
```json
{
  "type": "text",
  "text": "человек"
}
```

- **Прямоугольный промпт:**
```json
{
  "type": "box",
  "box": [0.25, 0.25, 0.5, 0.5],
  "label": true
}
```

- **Точечный промпт:**
```json
{
  "type": "point",
  "points": [[0.3, 0.3], [0.7, 0.7]],
  "point_labels": [1, 0]
}
```

**Ответ:**
```json
{
  "masks": ["rle-закодированные маски"],
  "boxes": [[cx, cy, w, h]],
  "scores": [0.95],
  "num_masks": 1,
  "image_size": {"width": 640, "height": 480},
  "visualization_url": null,
  "inference_time_ms": 123.4
}
```

#### Сегментация с кэшированными признаками
```
POST /api/v1/image/cached-features
```
Сегментирует изображение с несколькими текстовыми промптами, используя кэшированные признаки для ускорения.

**Тело запроса:**
```json
{
  "image": "base64-закодированное изображение",
  "text_prompts": ["человек", "автомобиль", "дерево"],
  "confidence_threshold": 0.5
}
```

**Ответ:**
```json
{
  "results": [
    {
      "prompt": "человек",
      "masks": ["rle-маска"],
      "boxes": [[0.3, 0.4, 0.2, 0.3]],
      "scores": [0.95],
      "num_masks": 1
    }
  ],
  "cache_hit": true,
  "inference_time_ms": 150.2
}
```

### Эндпоинты сегментации видео

#### Начать сессию видеообработки
```
POST /api/v1/video/session/start
```
Создает новую сессию для видеообработки.

**Тело запроса:**
```json
{
  "video_url": "https://example.com/video.mp4",
  "video_base64": "base64-видео",
  "video_path": "/path/to/video.mp4",
  "session_id": "custom-session-id",
  "gpu_ids": [0, 1]
}
```

**Ответ:**
```json
{
  "session_id": "генерированный-id",
  "video_info": {
    "total_frames": 100,
    "fps": 30.0,
    "resolution": {"width": 1920, "height": 1080},
    "duration_seconds": 3.33
  },
  "status": "ready"
}
```

#### Добавить промпт к кадру
```
POST /api/v1/video/session/{session_id}/prompt
```
Добавляет промпт к конкретному кадру для инициализации или уточнения отслеживания объектов.

**Тело запроса:**
```json
{
  "frame_index": 10,
  "prompts": [
    {
      "type": "text",
      "text": "человек"
    }
  ],
  "obj_id": null
}
```

**Ответ:**
```json
{
  "frame_index": 10,
  "obj_id": [1],
  "masks": ["rle-маска"],
  "boxes": [[0.3, 0.4, 0.2, 0.3]],
  "scores": [0.95],
  "status": "prompt_added"
}
```

#### Пропагация отслеживания
```
POST /api/v1/video/session/{session_id}/propagate
```
Распространяет отслеживание объектов по кадрам видео (не стриминг).

**Тело запроса:**
```json
{
  "direction": "both",
  "start_frame_index": 0,
  "max_frames": 50,
  "stream": false
}
```

**Ответ:**
```json
{
  "session_id": "session-id",
  "results": {
    "0": {
      "frame_index": 0,
      "objects": [
        {
          "id": 1,
          "mask": "rle-маска",
          "box": [0.3, 0.4, 0.2, 0.3],
          "score": 0.95
        }
      ]
    }
  },
  "total_frames": 1,
  "processing_time_ms": 250.5
}
```

#### WebSocket для стриминга пропагации
```
/ws/propagate/{session_id}
```
WebSocket-эндпоинт для стриминга результатов обработки кадров в реальном времени.

**Входное сообщение:**
```json
{
  "direction": "forward",
  "start_frame_index": 0,
  "max_frames": 100
}
```

**Выходные сообщения:**
- Фрейм: `{"type": "frame", "frame_index": 5, "objects": [...]}`  
- Завершение: `{"type": "complete", "total_frames": 100}`
- Ошибка: `{"type": "error", "error": "сообщение об ошибке"}`

#### Получить статус сессии
```
GET /api/v1/video/session/{session_id}/status
```
Получает текущий статус видео сессии.

**Ответ:**
```json
{
  "session_id": "session-id",
  "status": "ready",
  "current_objects": 2,
  "frames_processed": 50,
  "total_frames": 100,
  "gpu_memory_used_mb": 1024.5
}
```

#### Удалить объект из отслеживания
```
DELETE /api/v1/video/session/{session_id}/object/{obj_id}
```
Удаляет объект из отслеживания в сессии.

**Ответ:**
```json
{
  "session_id": "session-id",
  "obj_id": 1,
  "status": "removed"
}
```

#### Сбросить сессию
```
POST /api/v1/video/session/{session_id}/reset
```
Сбрасывает сессию в начальное состояние (очищает все промпты и объекты).

**Ответ:**
```json
{
  "session_id": "session-id",
  "status": "reset",
  "objects_cleared": 2
}
```

#### Закрыть сессию
```
DELETE /api/v1/video/session/{session_id}
```
Закрывает и очищает видео сессию.

**Ответ:**
```json
{
  "session_id": "session-id",
  "status": "closed",
  "memory_freed_mb": 1024.5
}
```

#### Список сессий
```
GET /api/v1/video/sessions
```
Список всех активных видео сессий.

**Ответ:**
```json
{
  "sessions": [
    {
      "session_id": "session-id",
      "type": "video",
      "created_at": "2023-12-01T10:00:00Z",
      "status": "ready",
      "objects_count": 2
    }
  ],
  "total_sessions": 1
}
```

## Развертывание

### Локальное развертывание

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Настройте переменные окружения в файле `.env`:
```env
SAM3_CHECKPOINT=/path/to/sam3.pt
SAM3_BPE_PATH=/path/to/bpe_simple_vocab_16e6.txt.gz
IMAGE_MODEL_DEVICE=cuda:0
VIDEO_GPU_LIST=[0,1]
```

3. Запустите сервер:
```bash
python -m app.main
```

### Docker развертывание

Сервер может быть развернут с использованием Docker:

```bash
# Сборка образа
docker build -t sam3-inference-server .

# Запуск контейнера
docker run -d --gpus all \
  -p 8000:8000 \
  -v /path/to/weights:/app/server/sam_weights \
  -e SAM3_CHECKPOINT=/app/server/sam_weights/sam3.pt \
  sam3-inference-server
```

### Docker Compose

Используйте файл `docker-compose.yml` для развертывания:

```yaml
version: '3.8'
services:
  sam3-server:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - ./sam_weights:/app/server/sam_weights
    environment:
      - SAM3_CHECKPOINT=/app/server/sam_weights/sam3.pt
      - IMAGE_MODEL_DEVICE=cuda:0
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
```

## Устранение неполадок

### Общие проблемы

1. **Ошибка загрузки модели**: Проверьте, что путь к чекпоинту SAM3 указан правильно и файл существует.

2. **Недостаточно памяти GPU**: Уменьшите разрешение входных изображений или используйте модель с меньшим потреблением памяти.

3. **Ошибки при обработке видео**: Убедитесь, что формат видео поддерживается (MP4, AVI и т.д.).

4. **Проблемы с сессиями**: Проверьте, что сессии правильно создаются и закрываются, чтобы избежать утечек памяти.

### Логирование

Сервер использует loguru для логирования. Уровень логирования можно настроить через переменную `LOG_LEVEL`:
- `DEBUG` - подробная информация для отладки
- `INFO` - общая информация о работе сервера
- `WARNING` - предупреждения
- `ERROR` - ошибки
- `CRITICAL` - критические ошибки

### Мониторинг

Сервер может предоставлять метрики через отдельный порт (по умолчанию 9090), если включена опция `ENABLE_METRICS`.

### API Ключи

Если включена аутентификация через API-ключи, убедитесь, что заголовок `X-API-Key` включен в каждый запрос:
```
X-API-Key: your-api-key
```

### Ограничение частоты

Сервер включает ограничение частоты запросов (по умолчанию 100 запросов в минуту на клиента). Это можно настроить или отключить через переменные конфигурации.