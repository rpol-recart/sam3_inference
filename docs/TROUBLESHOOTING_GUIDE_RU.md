# Руководство по устранению неполадок SAM3 Inference Server

## Оглавление
1. [Общие проблемы](#общие-проблемы)
2. [Проблемы с моделями](#проблемы-с-моделями)
3. [Проблемы с GPU и памятью](#проблемы-с-gpu-и-памятью)
4. [Проблемы с API и сетью](#проблемы-с-api-и-сетью)
5. [Проблемы с сессиями](#проблемы-с-сессиями)
6. [Диагностика и отладка](#диагностика-и-отладка)
7. [Часто задаваемые вопросы](#часто-задаваемые-вопросы)

## Общие проблемы

### Сервер не запускается

**Симптом:** Ошибка при запуске сервера

**Возможные причины и решения:**
1. **Отсутствуют зависимости:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Неправильная версия Python:**
   - Убедитесь, что используется Python 3.9+
   - Проверьте версию: `python --version`

3. **Неправильный путь к весам модели:**
   - Проверьте значение `SAM3_CHECKPOINT`
   - Убедитесь, что файл существует

4. **Конфликт портов:**
   - Проверьте, занят ли порт 8000
   - Используйте другой порт: `SERVER_PORT=8001`

### Ошибка "Module not found"

**Симптом:** `ImportError: No module named '...'`

**Решения:**
1. Убедитесь, что все зависимости установлены:
   ```bash
   pip install -r requirements.txt
   ```

2. Проверьте правильность установки PyTorch с поддержкой CUDA:
   ```bash
   python -c "import torch; print(torch.cuda.is_available())"
   ```

3. Убедитесь, что путь к SAM3 библиотеке добавлен в sys.path

### Ошибка "Address already in use"

**Симптом:** `OSError: [Errno 98] Address already in use`

**Решения:**
1. Найдите процессы, использующие порт:
   ```bash
   lsof -i :8000  # Linux/Mac
   netstat -ano | findstr :8000  # Windows
   ```

2. Убейте процесс:
   ```bash
   kill -9 <PID>  # Linux/Mac
   taskkill /PID <PID> /F  # Windows
   ```

3. Или используйте другой порт:
   ```bash
   SERVER_PORT=8001 python -m app.main
   ```

## Проблемы с моделями

### Ошибка загрузки модели

**Симптом:** `Failed to load image model` или `Failed to load video model`

**Возможные причины:**
1. **Неправильный путь к чекпоинту:**
   - Проверьте `SAM3_CHECKPOINT` в настройках
   - Убедитесь, что файл существует и доступен

2. **Несовместимый формат модели:**
   - Убедитесь, что используется правильная версия SAM3 модели
   - Проверьте совместимость с установленной библиотекой

3. **Недостаточно памяти:**
   - Проверьте доступную RAM и GPU память
   - Попробуйте использовать CPU: `IMAGE_MODEL_DEVICE=cpu`

**Решения:**
1. Проверьте путь к модели:
   ```bash
   ls -la /path/to/sam3.pt
   ```

2. Убедитесь, что права доступа к файлу корректны:
   ```bash
   chmod 644 /path/to/sam3.pt
   ```

3. Попробуйте загрузить модель в Python:
   ```python
   import torch
   model = torch.load('/path/to/sam3.pt')
   ```

### Модель не отвечает

**Симптом:** Запросы к модели виснут или таймаутятся

**Возможные причины:**
1. **Проблемы с GPU:**
   - GPU перегружен
   - Ошибка драйвера

2. **Большой размер изображения:**
   - Изображение слишком велико для обработки

3. **Проблемы с памятью:**
   - Недостаточно GPU или RAM памяти

**Решения:**
1. Уменьшите размер изображения перед обработкой
2. Проверьте использование GPU: `nvidia-smi`
3. Используйте CPU для тестирования: `IMAGE_MODEL_DEVICE=cpu`

## Проблемы с GPU и памятью

### Ошибка CUDA Out of Memory

**Симптом:** `CUDA out of memory` или `RuntimeError: CUDA error`

**Решения:**
1. **Уменьшите размер изображения:**
   - Используйте `image_model_resolution` для ограничения размера
   - Предварительно уменьшайте изображения перед отправкой

2. **Используйте CPU:**
   ```env
   IMAGE_MODEL_DEVICE=cpu
   VIDEO_GPU_LIST=[]
   ```

3. **Очистите память:**
   - Перезапустите сервер
   - Закройте все видео сессии
   - Используйте `torch.cuda.empty_cache()`

4. **Ограничьте количество сессий:**
   ```env
   MAX_CONCURRENT_SESSIONS=2
   ```

### GPU не обнаруживается

**Симптом:** `CUDA available: False` в логах

**Проверки:**
1. Установлены ли драйверы CUDA:
   ```bash
   nvidia-smi
   nvcc --version
   ```

2. Совместима ли версия PyTorch:
   ```python
   import torch
   print(torch.__version__)
   print(torch.cuda.is_available())
   print(torch.version.cuda)
   ```

3. Правильно ли установлен PyTorch с CUDA:
   ```bash
   pip uninstall torch
   pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
   ```

### Высокое потребление памяти

**Симптом:** Постоянно растущее использование памяти

**Возможные причины:**
1. **Утечки сессий:** сессии не закрываются должным образом
2. **Кэш признаков:** накапливается без очистки
3. **Несброшенные тензоры:** не освобождаются после использования

**Решения:**
1. Проверьте закрытие сессий:
   ```python
   # Убедитесь, что все сессии закрываются
   response = requests.delete(f"http://server/session/{session_id}")
   ```

2. Ограничьте кэш:
   ```env
   ENABLE_FEATURE_CACHE=False
   MAX_CACHE_SIZE_MB=1024
   ```

3. Добавьте очистку памяти в код модели:
   ```python
   def clear_cache(self):
       torch.cuda.empty_cache()
       gc.collect()
   ```

## Проблемы с API и сетью

### 404 ошибка для эндпоинтов

**Симптом:** `404 Not Found` для известных эндпоинтов

**Возможные причины:**
1. **Неправильный префикс маршрута**
2. **Маршрут не зарегистрирован**
3. **Проблемы с импортом зависимостей**

**Проверки:**
1. Убедитесь, что маршруты правильно импортированы в `app/main.py`
2. Проверьте документацию API: `http://server/docs`
3. Проверьте регистр букв в URL

### Ошибка при загрузке видео

**Симптом:** Ошибки при загрузке видео через `video_url`, `video_base64` или `video_path`

**Решения:**
1. **Для `video_url`:** убедитесь, что URL доступен:
   ```bash
   curl -I https://example.com/video.mp4
   ```

2. **Для `video_base64`:** проверьте формат и размер:
   - Убедитесь, что строка действительно base64
   - Проверьте размер файла (ограничен `MAX_UPLOAD_SIZE_MB`)

3. **Для `video_path`:** проверьте права доступа:
   ```bash
   ls -la /path/to/video.mp4
   ```

### Проблемы с WebSocket соединениями

**Симптом:** WebSocket соединения не устанавливаются или быстро отключаются

**Возможные причины:**
1. **Проблемы с reverse proxy**
2. **Таймауты соединений**
3. **Проблемы с CORS**

**Решения:**
1. Настройте proxy для WebSocket в nginx:
   ```nginx
   location /ws/ {
       proxy_pass http://backend;
       proxy_http_version 1.1;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection "upgrade";
       proxy_set_header Host $host;
   }
   ```

2. Проверьте CORS настройки:
   ```env
   CORS_ORIGINS_LIST=["*"]  # Только для тестирования
   ```

## Проблемы с сессиями

### Ошибка "Session not found"

**Симптом:** `SessionNotFoundError` при попытке работы с сессией

**Возможные причины:**
1. **Сессия истекла:** превышено время `SESSION_TIMEOUT_SECONDS`
2. **Неправильный ID сессии**
3. **Сервер перезапущен:** сессии не сохраняются между перезапусками

**Решения:**
1. Проверьте существование сессии:
   ```bash
   GET /api/v1/video/sessions
   ```

2. Увеличьте таймаут сессии:
   ```env
   SESSION_TIMEOUT_SECONDS=7200
   ```

3. Проверьте ID сессии в ответе на `POST /session/start`

### Утечка сессий

**Симптом:** Постоянно растущее количество сессий

**Решения:**
1. Убедитесь, что все сессии закрываются:
   ```python
   # Всегда закрывайте сессии после использования
   requests.delete(f"http://server/session/{session_id}")
   ```

2. Уменьшите таймаут сессии:
   ```env
   SESSION_TIMEOUT_SECONDS=1800
   SESSION_CLEANUP_INTERVAL_SECONDS=120
   ```

3. Проверьте автоматическую очистку:
   ```bash
   GET /api/v1/video/sessions  # Проверьте количество активных сессий
   ```

### Ошибка "Maximum sessions exceeded"

**Симптом:** `RuntimeError: Maximum sessions exceeded`

**Решения:**
1. Увеличьте лимит сессий:
   ```env
   MAX_CONCURRENT_SESSIONS=20
   ```

2. Закройте неиспользуемые сессии:
   ```bash
   # Закройте все сессии
   for session in $(curl -s http://server/sessions | jq -r '.sessions[].session_id'); do
     curl -X DELETE http://server/session/$session
   done
   ```

## Диагностика и отладка

### Включение подробного логирования

```env
LOG_LEVEL=DEBUG
```

### Проверка состояния системы

```bash
# Проверка использования GPU
nvidia-smi

# Проверка использования памяти
free -h

# Проверка процессов
ps aux | grep python

# Проверка сетевых соединений
netstat -tuln
```

### Анализ логов

```bash
# Просмотр логов приложения
tail -f app.log

# Поиск ошибок в логах
grep -i error app.log
grep -i exception app.log
```

### Тестирование компонентов

**Тестирование модели:**
```python
from app.models.sam3_image import SAM3ImageModel

# Создание модели
model = SAM3ImageModel(
    checkpoint="/path/to/checkpoint",
    device="cuda:0"
)

# Проверка информации о модели
print(model.model_info)
```

**Тестирование сервиса:**
```python
from app.services.image_service import ImageSegmentationService

service = ImageSegmentationService(model)
# Тестирование функций
```

### Мониторинг производительности

**CPU и память:**
```bash
htop
# или
top
```

**GPU:**
```bash
watch -n 1 nvidia-smi
```

**Сеть:**
```bash
iftop
# или
nethogs
```

## Часто задаваемые вопросы

### Q: Как увеличить максимальный размер загружаемого файла?

**A:** Измените переменную окружения:
```env
MAX_UPLOAD_SIZE_MB=200
```

### Q: Как использовать несколько GPU?

**A:** Укажите список GPU в настройках:
```env
VIDEO_GPU_LIST=[0,1,2,3]
```

Для сессии можно указать конкретные GPU:
```json
{
  "video_path": "/path/to/video.mp4",
  "gpu_ids": [0, 1]
}
```

### Q: Почему сессия закрывается сама по себе?

**A:** Сессии автоматически закрываются по таймауту. Проверьте:
```env
SESSION_TIMEOUT_SECONDS=3600
```

### Q: Как очистить кэш признаков?

**A:** Кэш можно очистить через API или перезапуск сервера. Также можно ограничить его размер:
```env
MAX_CACHE_SIZE_MB=2048
FEATURE_CACHE_TTL_SECONDS=600
```

### Q: Как работает кэширование признаков?

**A:** Кэширование позволяет ускорить обработку одного изображения с несколькими текстовыми промптами в ~10 раз. Признаки изображения кэшируются и переиспользуются для разных промптов.

### Q: Какие форматы видео поддерживаются?

**A:** Поддерживаются основные форматы: MP4, AVI, MOV, MKV, WMV, FLV, WEBM с кодеками H.264, VP9, HEVC.

### Q: Как управлять потреблением памяти?

**A:** 
- Ограничьте количество одновременных сессий
- Уменьшайте размеры изображений
- Используйте таймауты сессий
- Закрывайте сессии после использования
- Ограничьте размер кэша

### Q: Как работает пропагация в видео?

**A:** Пропагация распространяет сегментацию объектов по кадрам видео в заданном направлении (вперед, назад или в обе стороны) на основе начальных промптов.

### Q: Какие есть способы аутентификации?

**A:** 
- Через API-ключи (переменная `REQUIRE_API_KEY`)
- Заголовок: `X-API-Key: your-api-key`
- Список ключей в `API_KEYS`

### Q: Как обрабатывать ошибки в приложении?

**A:** 
- Проверяйте коды статуса HTTP
- Читайте сообщения об ошибках в теле ответа
- Проверяйте логи сервера
- Используйте try/catch блоки в клиентском коде