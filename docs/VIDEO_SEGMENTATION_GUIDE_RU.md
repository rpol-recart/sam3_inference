# Руководство по сегментации видео в SAM3 Inference Server

## Оглавление
1. [Введение](#введение)
2. [Управление сессиями](#управление-сессиями)
3. [Видеоформаты и требования](#видеоформаты-и-требования)
4. [Типы промптов для видео](#типы-промптов-для-видео)
5. [Пропагация отслеживания](#пропагация-отслеживания)
6. [WebSocket стриминг](#websocket-стриминг)
7. [Оптимизация производительности](#оптимизация-производительности)
8. [Примеры использования](#примеры-использования)

## Введение

Сегментация видео в SAM3 Inference Server позволяет отслеживать объекты на протяжении всего видео. Система использует подход с сессиями, где состояние отслеживания сохраняется между кадрами. Это позволяет точно отслеживать движущиеся объекты и обеспечивает согласованность сегментации по всему видео.

### Основные возможности:
- Многокадровое отслеживание объектов
- Поддержка нескольких объектов одновременно
- Возможность добавления/удаления объектов в процессе
- Пропагация в прямом и обратном направлениях
- WebSocket-стриминг для обработки в реальном времени
- Поддержка многопроцессорной обработки

## Управление сессиями

### Создание сессии

Сессия начинается с загрузки видео и подготовки внутреннего состояния отслеживания:

```json
{
  "video_url": "https://example.com/video.mp4",
  "video_base64": "base64-видео",
  "video_path": "/path/to/local/video.mp4",
  "session_id": "custom-session-id",
  "gpu_ids": [0, 1]
}
```

Доступные источники видео:
- `video_url` - URL для скачивания видео
- `video_base64` - base64-кодированное видео
- `video_path` - локальный путь к видеофайлу

### Жизненный цикл сессии

Сессии проходят через следующие состояния:
- `READY` - сессия готова к обработке
- `PROCESSING` - идет активная обработка
- `ERROR` - произошла ошибка
- `CLOSED` - сессия закрыта

### Управление сессиями

- `/session/{session_id}/status` - получить статус сессии
- `/session/{session_id}/reset` - сбросить сессию
- `/session/{session_id}` - закрыть сессию
- `/sessions` - получить список всех сессий

## Видеоформаты и требования

### Поддерживаемые форматы:
- MP4
- AVI
- MOV
- MKV
- WMV
- FLV
- WEBM

### Технические требования:
- Кодеки: H.264, VP9, HEVC
- Максимальное разрешение: зависит от доступной GPU памяти
- Рекомендуемый FPS: до 30
- Максимальная продолжительность: зависит от доступной памяти

### Ограничения:
- Очень длинные видео могут потреблять много памяти
- Высокое разрешение требует больше вычислительных ресурсов
- Количество одновременных сессий ограничено параметром `max_concurrent_sessions`

## Типы промптов для видео

### Добавление промпта к кадру

Промпты добавляются к конкретным кадрам для инициализации отслеживания:

```json
{
  "frame_index": 10,
  "prompts": [
    {
      "type": "text",
      "text": "человек"
    }
  ],
  "obj_id": null
}
```

### Типы промптов:
- **Текстовые** - для идентификации объекта
- **Прямоугольные** - для точного указания местоположения
- **Точечные** - для высокоточной сегментации

### Объекты и идентификаторы

Каждый отслеживаемый объект имеет уникальный ID:
- При первом добавлении объект получает новый ID
- Можно указать конкретный ID с помощью параметра `obj_id`
- Объекты могут быть удалены с помощью `/object/{obj_id}`

## Пропагация отслеживания

### Направления пропагации:
- `forward` - вперед по времени
- `backward` - назад по времени
- `both` - в обоих направлениях

### Пропагация в одном направлении

Для пропагации только вперед:

```json
{
  "direction": "forward",
  "start_frame_index": 10,
  "max_frames": 100,
  "stream": false
}
```

### Пропагация в обоих направлениях

Для пропагации вперед и назад от начального кадра:

```json
{
  "direction": "both",
  "start_frame_index": 50,
  "max_frames": 200,
  "stream": false
}
```

### Параметры пропагации:
- `direction` - направление пропагации
- `start_frame_index` - начальный кадр
- `max_frames` - максимальное количество кадров для обработки
- `stream` - использовать стриминг (WebSocket) или нет

## WebSocket стриминг

WebSocket стримминг позволяет получать результаты по мере их обработки, что особенно полезно для длинных видео или приложениям в реальном времени.

### Подключение к WebSocket

```
/ws/propagate/{session_id}
```

### Сообщения WebSocket

**Входное сообщение (клиент → сервер):**
```json
{
  "direction": "forward",
  "start_frame_index": 0,
  "max_frames": 100
}
```

**Выходные сообщения (сервер → клиент):**

Фрейм данных:
```json
{
  "type": "frame",
  "frame_index": 5,
  "objects": [
    {
      "id": 1,
      "mask": "rle-кодированная маска",
      "box": [0.3, 0.4, 0.2, 0.3],
      "score": 0.95
    }
  ]
}
```

Сообщение завершения:
```json
{
  "type": "complete",
  "total_frames": 100
}
```

Сообщение об ошибке:
```json
{
  "type": "error",
  "error": "описание ошибки"
}
```

### Преимущества WebSocket стриминга:
- Немедленное получение результатов
- Возможность визуализации в реальном времени
- Эффективное использование памяти
- Возможность отмены обработки

## Оптимизация производительности

### Использование нескольких GPU

Для ускорения обработки длинных видео используйте несколько GPU:

```json
{
  "video_path": "/path/to/video.mp4",
  "gpu_ids": [0, 1, 2, 3]
}
```

### Ограничение кадров

Для снижения вычислительной нагрузки:
- Используйте `max_frames` для обработки части видео
- Уменьшайте FPS при подготовке видео
- Обрабатывайте видео по сегментам

### Память и очистка

- Закрывайте сессии после использования
- Используйте `reset_session` для очистки объектов
- Мониторьте использование GPU памяти через статус сессии

### Пороги уверенности

Настройте пороги для фильтрации результатов:
- Высокий порог: точные, но возможно пропущенные объекты
- Низкий порог: больше объектов, но с риском ложных срабатываний

## Примеры использования

### Полный процесс сегментации видео

1. **Создание сессии:**
```bash
curl -X POST "http://localhost:8000/api/v1/video/session/start" \
  -H "Content-Type: application/json" \
  -d '{
    "video_path": "/path/to/video.mp4"
  }'
```

2. **Добавление промпта к кадру:**
```bash
curl -X POST "http://localhost:8000/api/v1/video/session/{session_id}/prompt" \
  -H "Content-Type: application/json" \
  -d '{
    "frame_index": 25,
    "prompts": [
      {
        "type": "text",
        "text": "человек"
      }
    ]
  }'
```

3. **Пропагация отслеживания:**
```bash
curl -X POST "http://localhost:8000/api/v1/video/session/{session_id}/propagate" \
  -H "Content-Type: application/json" \
  -d '{
    "direction": "both",
    "start_frame_index": 25
  }'
```

### Использование WebSocket стриминга

```javascript
const ws = new WebSocket(`ws://localhost:8000/ws/propagate/${sessionId}`);

ws.onopen = () => {
  // Отправить параметры пропагации
  ws.send(JSON.stringify({
    direction: "forward",
    start_frame_index: 0,
    max_frames: 100
  }));
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  
  if (data.type === 'frame') {
    console.log(`Кадр ${data.frame_index}:`, data.objects);
  } else if (data.type === 'complete') {
    console.log('Обработка завершена');
  } else if (data.type === 'error') {
    console.error('Ошибка:', data.error);
  }
};
```

### Многократное отслеживание разных объектов

1. **Добавление первого объекта:**
```json
{
  "frame_index": 50,
  "prompts": [
    {
      "type": "text",
      "text": "человек"
    }
  ]
}
```

2. **Добавление второго объекта:**
```json
{
  "frame_index": 55,
  "prompts": [
    {
      "type": "text", 
      "text": "автомобиль"
    }
  ]
}
```

3. **Пропагация обоих объектов:**
```json
{
  "direction": "both",
  "start_frame_index": 50
}
```

## Совместимость и интеграция

### Видеообработка в реальном времени

Сервер может быть интегрирован с системами видеонаблюдения:
- Используйте WebSocket стриминг для обработки потокового видео
- Обрабатывайте отдельные кадры по мере их поступления
- Используйте короткие сессии для минимизации задержки

### Пакетная обработка

Для обработки большого количества видео:
- Создавайте сессии асинхронно
- Используйте ограничение на количество одновременных сессий
- Обрабатывайте видео по очереди

### Интеграция с другими системами

Сервер легко интегрируется благодаря REST API:
- Простые JSON-запросы и ответы
- Поддержка CORS для веб-приложений
- Возможность аутентификации через API-ключи